rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function: Check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Any authenticated user can read basic profile info
      // (displayName, photoUrl needed for app)
      allow read: if isAuthenticated();

      // User can only update their own profile (match auth UID to document's uid field)
      // Note: userId in path is the custom user ID (e.g., "1000002"), not Firebase Auth UID
      allow update: if isAuthenticated()
        && request.auth.uid == resource.data.uid
        // Only allow specific fields to be modified
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'displayNameLower', 'updatedAt'])
        // Validate displayName. Note: size() uses the untrimmed value; trimming and final
        // length validation are enforced in the backend service.
        && request.resource.data.displayName is string
        && request.resource.data.displayName.size() >= 2
        && request.resource.data.displayName.size() <= 50;

      // Only server can create/delete users
      allow create, delete: if false;

      // --------------------------------------------
      // ACTIVITIES SUBCOLLECTION
      // Any authenticated user can read activities (for global feed)
      // Only server (Cloud Functions) writes activities
      // --------------------------------------------
      match /activities/{activityId} {
        allow read: if isAuthenticated();
        allow write: if false; // Server-only via Admin SDK
      }

      // --------------------------------------------
      // CONNECTED ACCOUNTS - SENSITIVE
      // Only the owner can read/write their connected accounts
      // Contains OAuth tokens, external account IDs
      // --------------------------------------------
      match /connectedAccounts/{accountId} {
        allow read, write: if isOwner(userId);
      }

      // --------------------------------------------
      // STATS SUBCOLLECTION
      // Owner can read their own stats
      // Authenticated users can read others' stats (leaderboard)
      // Only server writes stats
      // --------------------------------------------
      match /stats/{statId} {
        allow read: if isAuthenticated();
        allow write: if false; // Server-only via Admin SDK
      }

      // --------------------------------------------
      // REWARDS, BADGES, ACHIEVEMENTS
      // Owner can read their own
      // Others can read (for profile viewing)
      // Only server writes
      // --------------------------------------------
      match /rewards/{rewardId} {
        allow read: if isAuthenticated();
        allow write: if false; // Server-only via Admin SDK
      }

      match /badges/{badgeId} {
        allow read: if isAuthenticated();
        allow write: if false; // Server-only via Admin SDK
      }

      match /achievements/{achievementId} {
        allow read: if isAuthenticated();
        allow write: if false; // Server-only via Admin SDK
      }

      // --------------------------------------------
      // NOTIFICATIONS - PERSONAL
      // Only owner can read/write their notifications
      // --------------------------------------------
      match /notifications/{notificationId} {
        allow read, write: if isOwner(userId);
      }

      // --------------------------------------------
      // SETTINGS - PERSONAL
      // Only owner can read/write their settings
      // --------------------------------------------
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }

      // --------------------------------------------
      // ACTIVITY STATS SUBCOLLECTION
      // Time-based stats (daily, weekly) for progress tracking
      // --------------------------------------------
      match /activityStats/{document=**} {
        allow read: if isAuthenticated();
        allow write: if false; // Server-only via Admin SDK
      }
    }

    // ============================================
    // COLLECTION GROUP QUERIES
    // Allow authenticated users to query activities across all users
    // ============================================
    match /{path=**}/activities/{activityId} {
      allow read: if isAuthenticated();
    }

    // ============================================
    // SERVER-ONLY COLLECTIONS
    // These are only accessed by Cloud Functions via Admin SDK
    // ============================================

    // Game actions - server processing only
    match /gameActions/{actionId} {
      allow read, write: if false;
    }

    // Raw events - server processing only
    match /events/{eventId} {
      allow read, write: if false;
    }

    // Unmatched events - server processing only (admin portal reads via API)
    match /unmatchedEvents/{eventId} {
      allow read, write: if false;
    }

    // ============================================
    // DENY ALL OTHER ACCESS
    // Catch-all rule for any undefined paths
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
